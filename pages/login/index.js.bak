"use strict";const e=require("../../common/vendor.js"),t=require("../../utils/store.js"),n=require("../../utils/avatar.js"),i=require("../../utils/hints.js"),a=require("../../utils/edge-exit.js"),r=require("../../utils/navigation.js"),o=require("../../utils/useSafeArea.js"),h=require("../../utils/share.js");Math||s();const s=()=>"../../components/AppNavBar.js",c={__name:"index",setup(s){const c=e.ref({list:[],currentId:""}),u=e.ref(""),{hintState:l,showHint:d,hideHint:h}=i.useFloatingHint(),f=a.useEdgeExit({showHint:d,onExit:()=>b()});let g=0;e.onBackPress((()=>{const t=Date.now();if(t-g<2e3)b();else{g=t;try{d("再按一次返回退出应用",{duration:2e3,interactive:!1})}catch(n){e.index.showToast({title:"再按一次退出应用",icon:"none"})}}return!0}));const{safeTop:p}=o.useSafeArea(),x=e.computed((()=>({paddingTop:`${Math.max(0,p.value||0)}px`})));function v(){try{(e.index.getSystemInfoSync&&e.index.getSystemInfoSync()||{}).windowHeight||"undefined"!=typeof window&&window.innerHeight}catch(t){}}function w(){try{const e=t.getUsers();if(!e||!Array.isArray(e.list)||void 0===e.currentId)throw new Error("本地用户数据结构无效");c.value=e}catch(e){u.value=e&&e.message?e.message:"本地存储损坏"}}e.onMounted((()=>{t.ensureInit(),w();try{v()}catch(n){}e.index.onWindowResize&&e.index.onWindowResize((()=>{try{v()}catch(n){}}))}));const m=e.computed((()=>{const e=(c.value.list||[]).filter((e=>"Guest"!==String(e.name||""))).slice();return e.sort(((e,t)=>(t.lastPlayedAt||0)-(e.lastPlayedAt||0)||(t.createdAt||0)-(e.createdAt||0))),e}));function S(t){try{e.index.reLaunch({url:t})}catch(n){try{e.index.switchTab({url:t})}catch(i){}}}function y(){e.index.showModal({title:"新建玩家",editable:!0,placeholderText:"昵称（1-20字）",success(t){if(!t.confirm)return;const n=String(t.content||"").trim();if(!n||n.length<1||n.length>20)return void e.index.showToast({title:"请输入1-20字昵称",icon:"none"});(c.value.list||[]).some((e=>String(e.name||"").toLowerCase()===n.toLowerCase()))?e.index.showModal({title:"提示",content:"已有同名玩家，是否继续创建？",success(e){e.confirm?T(n):y()}}):T(n)}})}function T(t){e.index.showActionSheet({itemList:["请选择头像方式","从相册选择","随机分配","跳过"],success(n){const i=n.tapIndex;1===i?e.index.chooseImage({count:1,sizeType:["compressed"],success(e){const n=e.tempFilePaths&&e.tempFilePaths[0]||"",i=e.tempFiles&&e.tempFiles[0]&&e.tempFiles[0].size||0;A(t,n,i)},fail(){A(t,"")}}):(2===i||3===i)&&A(t,"")},fail(){A(t,"")}})}function A(i,a,r){const o=t.addUser(i,"");a&&n.saveAvatarForUser(o,a,{size:r}).then((t=>{if(!t||!t.ok)try{e.index.showToast({title:"头像保存失败，请重试",icon:"none"})}catch(n){}})),t.switchUser(o),t.touchLastPlayed(o),S("/pages/login/index")}function b(){r.exitApp({fallback:()=>{try{e.index.navigateBack({delta:1})}catch(t){try{e.index.reLaunch({url:"/pages/index/index"})}catch(n){}}}})}function D(e){if(!e)return"U";const t=String(e).trim();return t.length?t[0].toUpperCase():"U"}function M(e){if(!e)return"从未游玩";try{const t=new Date(e),n=Date.now(),i=new Date,a=t.toDateString()===i.toDateString(),r=t.getFullYear(),o=(t.getMonth()+1).toString().padStart(2,"0"),s=t.getDate().toString().padStart(2,"0"),c=t.getHours().toString().padStart(2,"0"),u=t.getMinutes().toString().padStart(2,"0");if(a)return`今天 ${c}:${u}`;const l=new Date(n-864e5);return t.toDateString()===l.toDateString()?`昨天 ${c}:${u}`:`${r}-${o}-${s} ${c}:${u}`}catch(t){return"时间未知"}}function $(e){const t=String(e.id||e.name||"");let n=0;for(let a=0;a<t.length;a++)n=33*n+t.charCodeAt(a)>>>0;const i=["#e2e8f0","#fde68a","#bbf7d0","#bfdbfe","#fecaca","#f5d0fe","#c7d2fe"];return i[n%i.length]}function j(){e.index.showModal({title:"重置数据",content:"将清空本地所有数据，是否继续？",success(e){e.confirm&&(t.resetAllData(),u.value="",w())}})}return(n,i)=>e.e({a:e.p({title:"无敌24点程序·观测",showBack:!1,"with-safe-top":!1}),b:u.value},u.value?{c:e.t(u.value),d:e.o(j)}:0===m.value.length?{f:e.o(y)}:{g:e.f(m.value,((n,i,a)=>e.e({a:n.avatar},n.avatar?{b:n.avatar}:{c:e.t(D(n.name)),d:n.color||$(n)},{e:e.t(n.name),f:e.t(M(n.lastPlayedAt)),g:n.id,h:e.o((e=>function(e){t.switchUser(e.id),t.touchLastPlayed(e.id),S("/pages/index/index")}(n)),n.id)}))),h:e.o(y)},{e:0===m.value.length,i:e.unref(l).visible},e.unref(l).visible?{j:e.t(e.unref(l).text),k:e.o((()=>{})),l:e.unref(l).interactive?1:"",m:e.o(((...t)=>e.unref(h)&&e.unref(h)(...t)))}:{},{n:e.s(x.value),o:e.o(((...t)=>e.unref(f).handleTouchStart&&e.unref(f).handleTouchStart(...t))),p:e.o(((...t)=>e.unref(f).handleTouchMove&&e.unref(f).handleTouchMove(...t))),q:e.o(((...t)=>e.unref(f).handleTouchEnd&&e.unref(f).handleTouchEnd(...t))),r:e.o(((...t)=>e.unref(f).handleTouchCancel&&e.unref(f).handleTouchCancel(...t)))})}},u=e._export_sfc(c,[["__scopeId","data-v-483539cc"]]);wx.createPage(u);
