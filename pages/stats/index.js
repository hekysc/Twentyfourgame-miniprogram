"use strict";const e=require("../../common/vendor.js"),t=require("../../utils/store.js"),a=require("../../utils/mistakes.js"),r=require("../../utils/hints.js"),n=require("../../utils/edge-exit.js"),s=require("../../utils/avatar.js"),u=require("../../utils/navigation.js"),i=require("../../utils/stats.js"),o=require("../../utils/useSafeArea.js"),l=require("../../utils/tab-cache.js"),share=require("../../utils/share.js");Math||(v+c)();const c=()=>"../../components/MiniBar.js",v=()=>"../../components/AppNavBar.js",d={__name:"index",setup(c){const{safeTop:v,safeBottom:d}=o.useSafeArea(),f=o.rpxToPx(24)||12,m=e.computed((()=>{const e=Math.max(0,v.value||0),t=Math.max(0,d.value||0);return{paddingTop:`${e+f}px`,paddingLeft:`${f}px`,paddingRight:`${f}px`,paddingBottom:`${f+t}px`,display:"flex",flexDirection:"column",rowGap:"18rpx",backgroundColor:"#f8fafc",boxSizing:"border-box",minHeight:"calc(var(--vh, 1vh) * 100)"}})),p=e.ref([]),h=e.ref(1);e.ref("all");const g=e.ref(""),y=e.computed((()=>p.value.map((e=>({id:e.id,name:e.name}))))),x=e.computed((()=>{var e;return(null==(e=y.value.find((e=>e.id===g.value)))?void 0:e.name)||"请选择用户"})),b=e.ref({}),M=e.computed((()=>{const e={};for(const t of p.value)e[t.id]={id:t.id,name:t.name};return e})),{hintState:w,showHint:S,hideHint:T}=r.useFloatingHint(),k=n.useEdgeExit({showHint:S,onExit:()=>{u.navigateToHome()}});share.enablePageShare(e);e.onBackPress((()=>(u.navigateToHome(),!0)));const N=e.ref({totals:{total:0,success:0,fail:0},days:{},rounds:[],agg:{}}),A=e.computed((()=>{var e,t;try{return((null==(t=null==(e=Y.value)?void 0:e.items)?void 0:t.length)||0)>=1}catch(a){return!1}})),F=e.ref({active:{},ledger:{}}),j=e.ref({totalWrongCount:0,totalActiveCount:0}),C=e.ref(!0),_=e.computed((()=>{const e=F.value||{active:{},ledger:{}},t=e.ledger||{},a=new Set(Object.keys(e.active||{})),r=[];for(const n of Object.keys(t)){const e=t[n]||{},s=Number.isFinite(e.attempts)?Math.max(0,Math.floor(e.attempts)):0,u=Number.isFinite(e.wrong)?Math.max(0,Math.floor(e.wrong)):0,i=Number.isFinite(e.correct)?Math.max(0,Math.floor(e.correct)):0,o=s||u+i,l=o?Math.round(u/o*100):0,c=Number.isFinite(e.streakCorrect)?Math.max(0,Math.floor(e.streakCorrect)):0,v=Number.isFinite(e.lastSeenTs)?Math.floor(e.lastSeenTs):0,d=Array.isArray(e.nums)?e.nums:"string"==typeof n?n.split(",").map((e=>+e||0)):[];r.push({key:e.key||n,displayKey:e.key||n||d.join(","),nums:d,attempts:o,wrong:u,correct:i,errorRate:l,streak:c,active:a.has(n),lastSeenTs:v,lastSeenText:v?L(v):"-"})}return r.sort(((e,t)=>t.lastSeenTs-e.lastSeenTs)),r})),R=e.computed((()=>{const e=_.value.slice(),t=C.value?e.filter((e=>e.active)):e;return t.sort(((e,t)=>t.attempts-e.attempts||t.wrong-e.wrong||t.lastSeenTs-e.lastSeenTs)),t}));function H(){let a=l.getCachedOverviewRows();a=Array.isArray(a)&&a.length?a.map((e=>({...e}))):t.allUsersWithStats(),a.sort(((e,t)=>t.winRate-e.winRate||t.totals.total-e.totals.total)),p.value=a,l.setCachedOverviewRows(a),function(a){const r=Array.isArray(a)?a:[];if(!r.length)return g.value&&(g.value=""),void $("");const n=g.value;if(n&&r.some((e=>e.id===n)))return void $(n);const s=function(a){var r;const n=Array.isArray(a)?a:[];if(!n.length)return"";const s=function(){try{if(void 0!==e.index&&"function"==typeof e.index.getStorageSync){const t=e.index.getStorageSync("tf24_stats_selected_user_v1");return"string"==typeof t?t:""}}catch(t){}return""}();if(s&&n.some((e=>e.id===s)))return s;const u=t.getCurrentUser();return u&&n.some((e=>e.id===u.id))?u.id:(null==(r=n[0])?void 0:r.id)||""}(r);s&&n!==s?g.value=s:!s&&n&&(g.value="");$(s)}(a)}function P(){const e={},a={};for(const n of p.value){if(!n||!n.id)continue;const r=l.getCachedStatsExt(n.id);if(r){e[n.id]=r;continue}const s=t.readStatsExtended(n.id);e[n.id]=s,a[n.id]=s}Object.keys(a).length&&l.mergeCachedStatsExt(a),b.value=e;const r=g.value;N.value=e[r]||{totals:{total:0,success:0,fail:0},days:{},rounds:[],agg:{}},O()}function O(){const e=g.value;if(!e)return F.value={active:{},ledger:{}},void(j.value={totalWrongCount:0,totalActiveCount:0});try{F.value=a.loadMistakeBook(e),j.value=a.getSummary(e)}catch(t){F.value={active:{},ledger:{}},j.value={totalWrongCount:0,totalActiveCount:0}}}function $(t){try{t?void 0!==e.index&&"function"==typeof e.index.setStorageSync&&e.index.setStorageSync("tf24_stats_selected_user_v1",t):void 0!==e.index&&"function"==typeof e.index.removeStorageSync&&e.index.removeStorageSync("tf24_stats_selected_user_v1")}catch(a){}}function D(e){var t;try{const a=0|(null==(t=null==e?void 0:e.detail)?void 0:t.value),r=y.value[a];r&&(g.value=r.id,$(r.id),P())}catch(a){}}function W(e=0){h.value=0===arguments.length?1:e}function q(e){var t;C.value=!!(null==(t=null==e?void 0:e.detail)?void 0:t.value)}function E(){const e=new Date;return e.setHours(0,0,0,0),e.getTime()}function B(){const e=Number(h.value);if(!e||e<=0)return 0;return E()-864e5*(e-1)}function L(e){try{const t=new Date(e);return`${t.getMonth()+1}/${t.getDate()} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`}catch(t){return"-"}}function K(e){if(!Number.isFinite(e))return"-";if(e<1e3)return e+"ms";const t=e/1e3;if(t<60)return t.toFixed(1)+"s";return`${Math.floor(t/60)}m${Math.round(t%60)}s`}function z(e){if(Number.isFinite(e))return e;const t=Number(e);if(Number.isFinite(t))return t;if("string"==typeof e){const t=e.trim().toUpperCase();if("A"===t)return 1;if("J"===t)return 11;if("Q"===t)return 12;if("K"===t)return 13}return null}function J(e){try{const t=function(e){return e&&"object"==typeof e?Array.isArray(e.cards)?e.cards.map(z).filter((e=>Number.isFinite(e))):e.hand&&Array.isArray(e.hand.cards)?e.hand.cards.map((e=>z(null==e?void 0:e.rank))).filter((e=>Number.isFinite(e))):Array.isArray(e.nums)?e.nums.map(z).filter((e=>Number.isFinite(e))):[]:[]}(e);return t.length?t.map((e=>String(Math.trunc(e)))).join(","):"-"}catch(t){return"-"}}e.onMounted((()=>{try{e.index.hideTabBar&&e.index.hideTabBar()}catch(a){}t.ensureInit(),H(),P(),s.consumeAvatarRestoreNotice()&&S("头像文件丢失，已为你恢复为默认头像",2e3)})),e.onShow((()=>{H(),P(),s.consumeAvatarRestoreNotice()&&S("头像文件丢失，已为你恢复为默认头像",2e3)})),e.onPullDownRefresh((()=>{try{H(),P()}finally{try{e.index.stopPullDownRefresh&&e.index.stopPullDownRefresh()}catch(t){}}})),e.watch(g,((e,t)=>{e!==t&&(C.value=!0),O(),$(e||"")}));const U=e.computed((()=>{const e=g.value;if("all"===e){const e=[];for(const t of Object.keys(b.value||{})){const a=b.value[t],r=((null==a?void 0:a.rounds)||[]).map((e=>({...e,uid:t})));e.push(...r)}return e.sort(((e,t)=>(t.ts||0)-(e.ts||0)))}return((b.value[e]||{rounds:[]}).rounds||[]).map((t=>({...t,uid:e})))})),I=e.computed((()=>{const e=U.value,t=B();return e.filter((e=>!t||(e.ts||0)>=t))})),G=e.computed((()=>I.value.slice().sort(((e,t)=>(t.ts||0)-(e.ts||0))).slice(0,12).map((e=>({...e,user:M.value[e.uid],cardsText:J(e)}))).reverse()));function Q(e){const t=new Date(e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}const Y=e.computed((()=>{const e=I.value,t=new Map;for(const o of e){const e=Q(o.ts||0),a=t.get(e)||{total:0,success:0};a.total+=1,o.success&&(a.success+=1),t.set(e,a)}const a=E(),r=Q(a);let n=[];if(h.value>0){for(let e=a-864e5*((Number(h.value)||1)-1);e<=a;e+=864e5)n.push(Q(e))}else n=Array.from(t.keys()),n.includes(r)||n.push(r),n.sort(),n.length>30&&(n=n.slice(-30));const s=n.map((e=>{const a=t.get(e)||{total:0,success:0},r=a.total||0,n=a.success||0;return{key:e,total:r,success:n,winRate:r?n/r:0}})),u=Math.max(1,...s.map((e=>e.total))),i=s.map((e=>{const t=e.total?Math.max(4,Math.round(e.total/u*160)):0,a=e.total?Math.round(t*e.winRate):0,r=Math.max(0,t-a);return{label:e.key,shortLabel:(n=e.key,n?n.slice(5).replace("-","/"):""),totalHeight:t,successHeight:a,failHeight:r};var n}));return{items:i,barWidth:24,gap:12,chartHeight:160,width:i.length?36*i.length-12:0}})),V=e.computed((()=>i.computeOverviewRows(p.value,b.value,B()))),X=e.computed((()=>{const e=g.value,t=e&&b.value[e]||{rounds:[]},a=B(),r=t.rounds||[];return a>0?r.filter((e=>(e.ts||0)>=a)):r.slice()}));const Z=e.computed((()=>i.summarizeNearMisses(X.value))),ee=e.computed((()=>{const e=["+","-","×","÷"],t=Object.fromEntries(e.map((e=>[e,{total:0,success:0}]))),a=Object.fromEntries(e.map((e=>[e,0])));for(const u of X.value){const e=Array.isArray(null==u?void 0:u.ops)?u.ops:[];if(e.length){const a=e[0];t[a]&&(t[a].total+=1,u.success&&(t[a].success+=1))}for(const t of e)null!=a[t]&&(a[t]+=1)}const r=Object.values(a).reduce(((e,t)=>e+t),0);let n=0;if(r>0)for(const u of e){const e=a[u]/r;e>0&&(n+=-e*Math.log2(e))}const s=Math.log2(4);return{first:t,allCounts:a,totalOps:r,entropy:n,entropyPct:s?Math.round(n/s*100):0}})),te=e.computed((()=>{const e=(X.value||[]).slice().sort(((e,t)=>(e.ts||0)-(t.ts||0)));let t=0,a=0,r=0,n=0;for(const s of e)s.success?(t+=1,t>a&&(a=t),r=0):(r+=1,r>n&&(n=r),t=0);return{curWin:t,maxWin:a,curLose:r,maxLose:n}})),ae=e.computed((()=>{const e=X.value||[],t=e.length||1,a=(a,r,n)=>{let s=0,u=0;for(const t of e){!!n(t)&&(s+=1,t.success&&(u+=1))}return{key:a,label:r,usePct:Math.round(s/t*100),winPct:s?Math.round(u/s*100):0}},r=(e,t)=>Array.isArray(null==e?void 0:e.ops)&&e.ops.includes(t);return[a("plus","＋ 加法",(e=>r(e,"+"))),a("minus","－ 减法",(e=>r(e,"-"))),a("mul","× 乘法",(e=>r(e,"×"))),a("div","÷ 除法",(e=>r(e,"÷")||"string"==typeof(null==e?void 0:e.expr)&&e.expr.includes("/"))),a("paren","括号",(e=>"string"==typeof(null==e?void 0:e.expr)&&/[()]/.test(e.expr))),a("frac","分数",(e=>{if("string"==typeof(null==e?void 0:e.expr)&&/[.]/.test(e.expr))return!0;if("string"==typeof(null==e?void 0:e.expr)&&/[÷/]/.test(e.expr))return!0;const t="string"==typeof(null==e?void 0:e.expr)?function(e){if(!e||"string"!=typeof e)return null;const t=e.replace(/×/g,"*").replace(/÷/g,"/").replace(/\s+/g,"");if(!/^[0-9+\-*/().]+$/.test(t))return null;try{const e=Function(`"use strict";return(${t})`)();return"number"==typeof e&&Number.isFinite(e)?e:null}catch(a){return null}}(e.expr):null;return null!=t&&Math.abs(t-Math.round(t))>1e-9}))]})),re=e.computed((()=>i.computeDailySeries(I.value)));function ne(e){const t=re.value;if(!t.length)return{win:0,avg:"-"};const a=t.slice(-e),r=a.reduce(((e,[,t])=>e+t.total),0),n=a.reduce(((e,[,t])=>e+t.success),0),s=a.flatMap((([,e])=>e.successTimes));return{win:r?Math.round(100*n/r):0,avg:s.length?K(Math.round(s.reduce(((e,t)=>e+t),0)/s.length)):"-"}}e.computed((()=>({win7:ne(7).win,win30:ne(30).win,avg7:ne(7).avg,avg30:ne(30).avg})));const se=e.computed((()=>{const e=[],t=X.value||[],a=t.length,r=t.filter((e=>e.success)).length,n=a?100*r/a:0;ee.value.entropyPct>=75?e.push("多样探索者"):ee.value.entropyPct<=35&&e.push("单核惯性");const s=Math.max(1,ee.value.totalOps);(ee.value.allCounts["×"]||0)/s>=.4&&e.push("乘法信徒"),Z.value.count>0&&Z.value.lt1>=50&&e.push("精准狙击");const u=(ae.value||[]).find((e=>"frac"===e.key));u&&u.usePct>0&&n-u.winPct>=20&&e.push("分数恐惧症");const i=t.filter((e=>e.success&&Number.isFinite(e.retries)&&e.retries>0)).length,o=t.filter((e=>e.success)).length||1;i/o>=.5&&o>=4&&e.push("逆转之王");const l=t.filter((e=>e.success&&Number.isFinite(e.timeMs))).map((e=>e.timeMs));(l.length?Math.min(...l):1/0)<=1500&&e.push("极速手");return(t.filter((e=>Number.isFinite(e.retries))).reduce(((e,t)=>e+t.retries),0)/Math.max(1,t.filter((e=>Number.isFinite(e.retries))).length)||0)>=1&&n>=50&&e.push("磨刀匠"),e})),ue=e.computed((()=>i.computeSpeedBuckets(X.value).map((e=>{const t=e.total||0,a=e.success||0,r=e.fail||0,n=Number.isFinite(e.avgTimeMs)?e.avgTimeMs:null,s=t?Math.round(a/t*100):0;return{label:e.label,total:t,success:a,fail:r,successRate:s,avgTimeMs:n,avgTimeText:null!=n?K(n):"-"}})))),ie=e.ref("winRate"),oe=e.ref("desc");try{const t=e.index.getStorageSync&&e.index.getStorageSync("tf24_overview_sort_v1"),a=t&&("string"==typeof t?JSON.parse(t):t);a&&a.key&&a.dir&&("asc"===a.dir||"desc"===a.dir)&&(ie.value=a.key,oe.value=a.dir)}catch(ve){}function le(t){const a="name"===t||"avgTimeMs"===t||"bestTimeMs"===t?"asc":"desc";ie.value!==t?(ie.value=t,oe.value=a):oe.value="asc"===oe.value?"desc":"asc",function(){try{e.index.setStorageSync&&e.index.setStorageSync("tf24_overview_sort_v1",JSON.stringify({key:ie.value,dir:oe.value}))}catch(ve){}}()}const ce=e.computed((()=>{try{const e=[...Array.isArray(V)?V:(null==V?void 0:V.value)||[]],t=ie.value,a="asc"===oe.value?1:-1;return e.sort(((e,r)=>{const n=null==e?void 0:e[t],s=null==r?void 0:r[t];if("name"===t){const e=String(n??""),t=String(s??"");return e.localeCompare(t,"zh")*a}if("avgTimeMs"===t||"bestTimeMs"===t){const e=e=>null==e||""===e||"-"===e||!Number.isFinite(Number(e)),t=e(n),r=e(s);if(t&&r)return 0;if(t)return 1;if(r)return-1;const u=Number(n),i=Number(s);return u===i?0:(u>i?1:-1)*a}const u=Number.isFinite(n)?n:-1/0,i=Number.isFinite(s)?s:-1/0;return u===i?0:(u>i?1:-1)*a})),e}catch(ve){return[]}}));return(t,a)=>e.e({a:e.p({title:"历史统计","show-back":!0,"with-safe-top":!1,"back-to-index":!0}),b:1===h.value?1:"",c:e.o((e=>W(1))),d:3===h.value?1:"",e:e.o((e=>W(3))),f:7===h.value?1:"",g:e.o((e=>W(7))),h:30===h.value?1:"",i:e.o((e=>W(30))),j:0===h.value?1:"",k:e.o((e=>W(0))),l:e.o((e=>le("name"))),m:"name"===ie.value?1:"",n:e.o((e=>le("times"))),o:"times"===ie.value?1:"",p:e.o((e=>le("success"))),q:"success"===ie.value?1:"",r:e.o((e=>le("winRate"))),s:"winRate"===ie.value?1:"",t:e.o((e=>le("avgTimeMs"))),v:"avgTimeMs"===ie.value?1:"",w:e.o((e=>le("bestTimeMs"))),x:"bestTimeMs"===ie.value?1:"",y:e.f(ce.value,((t,a,r)=>({a:e.t(a+1),b:e.t(t.name),c:e.t(t.times),d:e.t(t.success),e:e.t(t.fail),f:e.t(t.winRate),g:e.t(null!=t.avgTimeMs?K(t.avgTimeMs):"-"),h:e.t(null!=t.bestTimeMs?K(t.bestTimeMs):"-"),i:t.id,j:e.o((e=>{return a=t.id,g.value=a||"",$(g.value),void P();var a}),t.id)}))),z:g.value},g.value?{A:e.t(x.value),B:y.value,C:e.o(D)}:{},{D:g.value},g.value?{E:e.f(Y.value.items,((e,t,a)=>({a:e.failHeight+"rpx",b:e.successHeight+"rpx",c:e.totalHeight+"rpx",d:e.label||t}))),F:Y.value.barWidth+"rpx",G:Y.value.gap+"rpx",H:Y.value.width?Y.value.width+"rpx":"100%",I:Y.value.width?Y.value.width+"rpx":"100%",J:Y.value.chartHeight+"rpx",K:e.f(Y.value.items,((t,a,r)=>({a:e.t(t.shortLabel),b:"label-"+a}))),L:Y.value.barWidth+"rpx",M:A.value?1:"",N:Y.value.gap+"rpx",O:Y.value.width?Y.value.width+"rpx":"100%",P:e.t(te.value.curWin),Q:e.t(te.value.maxWin),R:e.t(te.value.curLose),S:e.t(te.value.maxLose)}:{},{T:g.value},g.value?e.e({U:G.value.length},G.value.length?{V:e.f((G.value||[]).slice().reverse(),((t,a,r)=>({a:e.t(L(t.ts)),b:e.t(t.success?"成功":"失败"),c:t.success?1:"",d:t.success?"":1,e:e.t(null!=t.timeMs&&Number.isFinite(t.timeMs)?(t.timeMs/1e3).toFixed(1)+"s":"-"),f:e.t(t.cardsText),g:t.id})))}:{}):{},{W:g.value},g.value?e.e({X:e.t(j.value.totalWrongCount),Y:e.t(j.value.totalActiveCount),Z:C.value,aa:e.o(q),ab:R.value.length},R.value.length?{ac:e.f(R.value,((t,a,r)=>({a:e.t(t.displayKey),b:e.o((a=>function(t){try{const a="string"==typeof(null==t?void 0:t.displayKey)&&t.displayKey.trim()?t.displayKey:"string"==typeof(null==t?void 0:t.key)?t.key:"";if(!a)return;const r=()=>{try{void 0!==e.index&&"function"==typeof e.index.showToast?e.index.showToast({title:"题目 key 已复制",icon:"none"}):S("题目 key 已复制",1200)}catch(ve){S("题目 key 已复制",1200)}},n=()=>{S("复制失败，请手动选择",1500)};if(void 0!==e.index&&"function"==typeof e.index.setClipboardData)return void e.index.setClipboardData({data:a,success:r,fail:n});if("undefined"!=typeof navigator&&navigator.clipboard&&"function"==typeof navigator.clipboard.writeText)return void navigator.clipboard.writeText(a).then(r).catch(n);n()}catch(ve){S("复制失败，请重试",1500)}}(t)),t.key),c:e.t(t.attempts),d:e.t(t.wrong),e:e.t(t.correct),f:e.t(t.active?"是":"否"),g:t.active?1:"",h:t.key})))}:{ad:e.t(C.value?"当前无活动错题":"暂无错题记录")}):{},{ae:g.value},g.value?{af:e.f(se.value,((t,a,r)=>({a:e.t(t),b:a})))}:{},{ag:g.value},g.value?{ah:e.f(ue.value,((t,a,r)=>({a:e.t(t.label),b:e.t(t.total),c:e.t(t.success),d:e.t(t.fail),e:"f179e625-1-"+r,f:e.p({pct:t.successRate}),g:e.t(t.avgTimeText),h:t.label})))}:{},{ai:g.value},g.value?{aj:e.f(ae.value,((t,a,r)=>({a:e.t(t.label),b:e.t(t.usePct),c:e.t(t.winPct),d:t.key})))}:{},{ak:e.unref(w).visible},e.unref(w).visible?{al:e.t(e.unref(w).text),am:e.o((()=>{})),an:e.unref(w).interactive?1:"",ao:e.o(((...t)=>e.unref(T)&&e.unref(T)(...t)))}:{},{ap:e.s(m.value),aq:e.o(((...t)=>e.unref(k).handleTouchStart&&e.unref(k).handleTouchStart(...t))),ar:e.o(((...t)=>e.unref(k).handleTouchMove&&e.unref(k).handleTouchMove(...t))),as:e.o(((...t)=>e.unref(k).handleTouchEnd&&e.unref(k).handleTouchEnd(...t))),at:e.o(((...t)=>e.unref(k).handleTouchCancel&&e.unref(k).handleTouchCancel(...t)))})}},f=e._export_sfc(d,[["__scopeId","data-v-f179e625"]]);wx.createPage(f);
