"use strict";const r=require("../utils/solver.js"),e=require("../utils/calc.js");function a(r){return(r||[]).map((r=>r?{id:r.id,alive:r.alive,value:r.value?{n:r.value.n,d:r.value.d}:null,expr:r.expr,displayExpression:r.displayExpression||r.displayExpr,displayExpr:r.displayExpr,label:r.label,card:r.card?{rank:r.card.rank,suit:r.card.suit}:null,source:r.source}:null))}function s(r,a){if(!r)return"";const s=e.mapCardRank(r.rank,a);return 11!==r.rank&&12!==r.rank&&13!==r.rank||a?e.labelForRank(r.rank):String(s)}exports.combineBasicSlots=function(s,l,i,n){const{slots:t,history:o=[],expression:u="",displayExpression:p=""}=s||{};if(l===i)return{ok:!1,err:"SAME_INDEX"};const d=t&&t[l],c=t&&t[i];if(!(d&&c&&d.alive&&c.alive))return{ok:!1,err:"INACTIVE_SLOT"};let x;try{x=e.operateFractions(d.value,c.value,n)}catch(h){return h&&"divide-by-zero"===h.message?{ok:!1,err:"DIVIDE_BY_ZERO"}:{ok:!1,err:"INVALID_OPERATION"}}if(!x)return{ok:!1,err:"INVALID_OPERATION"};const v={slots:a(t),expression:u,displayExpression:p},E=`(${d.expr}${n}${c.expr})`,y=`(${d.displayExpr}${n}${c.displayExpr})`,k=t.map(((a,s)=>a?s===l?{...a,alive:!1}:s===i?{id:a.id,alive:!0,value:x,expr:E,displayExpr:y,label:e.formatFractionValue(x),card:null,source:"value"}:a.value?{id:a.id,alive:a.alive,value:a.value?new r.Fraction(a.value.n,a.value.d):null,expr:a.expr,displayExpr:a.displayExpr,label:a.label,card:a.card?{rank:a.card.rank,suit:a.card.suit}:null,source:a.source}:{...a}:null)),f=k.filter((r=>r&&r.alive)),I=e.stripOuterParens(E),b=e.statsFromExpressionString(I);return{ok:!0,data:{slots:k,history:[...o,v],expression:E,displayExpression:e.formatExpressionWithValue(y,x),result:x,aliveCount:f.length,exprForRecord:I,stats:b,isSolved:1===f.length&&x.equalsInt&&x.equalsInt(24)}}},exports.createBasicState=function(a,l){const i=[];for(let n=0;n<4;n++){const t=a&&a[n];if(t){const a=e.mapCardRank(t.rank,l),o=new r.Fraction(a,1);i.push({id:n,alive:!0,value:o,expr:String(a),displayExpr:s(t,l),label:e.formatFractionValue(o),card:{rank:t.rank,suit:t.suit},source:"card"})}else i.push({id:n,alive:!1,value:null,expr:"",displayExpr:"",label:"",card:null,source:"card"})}return{slots:i,expression:"",displayExpression:""}},exports.undoBasicHistory=function(e){if(!e||!e.length)return{ok:!1,err:"EMPTY_HISTORY"};const a=e.slice(0,e.length-1),s=e[e.length-1];return{ok:!0,data:{history:a,slots:s.slots||[],expression:s.expression||"",displayExpression:s.displayExpression||""}}};const a=e.slice(0,e.length-1),s=e[e.length-1];return{ok:!0,data:{history:a,slots:(l=s.slots||[],(l||[]).map((e=>e?{id:e.id,alive:e.alive,value:e.value?new r.Fraction(e.value.n,e.value.d):null,expr:e.expr,displayExpr:e.displayExpr||e.displayExpression||"",label:e.label,card:e.card?{rank:e.card.rank,suit:e.card.suit}:null,source:e.source}:null))),expression:s.expression||"",displayExpression:s.displayExpression||""}};var l};
