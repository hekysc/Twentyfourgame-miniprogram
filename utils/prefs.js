"use strict";const t=require("../common/vendor.js"),e={"jqk-1":{rankMode:"jqk-1",ranks:{A:1,J:1,Q:1,K:1}},"jqk-11-12-13":{rankMode:"jqk-11-12-13",ranks:{A:1,J:11,Q:12,K:13}}},n={lastMode:"basic",lastHintTs:0,avatarMeta:{},rankMode:"jqk-11-12-13",ranks:{...e["jqk-11-12-13"].ranks},deckSource:"regular",mixWeight:50,haptics:!0,sfx:!0,reducedMotion:!1,rankMigrationNotice:!1};function r(e){try{const r=t.index.getStorageSync(e);if(!r)return null;if("string"==typeof r)try{return JSON.parse(r)}catch(n){return null}return r&&"object"==typeof r?r:null}catch(n){return null}}function o(e){try{t.index.setStorageSync("tf24_prefs_v2",JSON.stringify(e||{}))}catch(n){}}function i(t){const n=e[t];return n?{...n.ranks}:{...e["jqk-11-12-13"].ranks}}function a(t){return"mistakes"===t||"mix"===t?t:"regular"}function s(t){const r={...n,...t||{}};return r.lastMode="pro"===r.lastMode?"pro":"basic",r.lastHintTs=Number.isFinite(r.lastHintTs)?r.lastHintTs:0,r.avatarMeta=r.avatarMeta&&"object"==typeof r.avatarMeta?r.avatarMeta:{},r.rankMode=e[r.rankMode]?r.rankMode:"jqk-11-12-13",r.ranks=i(r.rankMode),r.deckSource=a(r.deckSource),r.mixWeight=Number.isFinite(r.mixWeight)?Math.min(100,Math.max(0,Math.round(r.mixWeight))):50,r.haptics=!!r.haptics,r.sfx=!!r.sfx,r.reducedMotion=!!r.reducedMotion,r.rankMigrationNotice=!!r.rankMigrationNotice,r}function c(){const i=r("tf24_prefs_v2")||r("tf24_prefs_v1")||{},a={...n,...i},c=function(){const t=["tf24_face_ranks_v1","tf24_face_ranks"];for(let e=0;e<t.length;e++){const n=r(t[e]);if(n&&"object"==typeof n){const t={J:Number(n.J),Q:Number(n.Q),K:Number(n.K)};if(3===[t.J,t.Q,t.K].filter((t=>Number.isFinite(t))).length)return t}}return null}();let u=!1;if(c){[e["jqk-1"].ranks,e["jqk-11-12-13"].ranks].some((t=>t.J===c.J&&t.Q===c.Q&&t.K===c.K))||(u=!0)}a.rankMode=u?"jqk-11-12-13":function(){try{const t=r("tf24_game_session_v1");if(t&&"boolean"==typeof t.faceUseHigh)return t.faceUseHigh?"jqk-11-12-13":"jqk-1"}catch(t){}return"jqk-11-12-13"}(),a.rankMigrationNotice=u;const f=s(a);o(f);try{t.index.removeStorageSync("tf24_prefs_v1")}catch(d){}return f}let u=null;function f(){if(u)return u;const t=r("tf24_prefs_v2");return t?(u=s(t),o(u),u):(u=c(),u)}function d(t){const e=f(),n="function"==typeof t?t({...e}):{...e,...t||{}};return u=s(n),o(u),u}function k(t,e){t&&d((n=>{const r={...n.avatarMeta||{}};return e&&e.uri?r[t]={uri:e.uri,lastModified:Number.isFinite(e.lastModified)?e.lastModified:Date.now()}:delete r[t],{...n,avatarMeta:r}}))}exports.clearAvatarMeta=function(t){k(t,null)},exports.consumeRankMigrationNotice=function(){d((t=>({...t,rankMigrationNotice:!1})))},exports.getGameplayPrefs=function(){const t=f();return{rankMode:t.rankMode,ranks:i(t.rankMode),deckSource:t.deckSource,mixWeight:t.mixWeight,haptics:t.haptics,sfx:t.sfx,reducedMotion:t.reducedMotion,rankMigrationNotice:t.rankMigrationNotice}},exports.getLastHintTimestamp=function(){const t=f();return Number.isFinite(t.lastHintTs)?t.lastHintTs:0},exports.getLastMode=function(){return"pro"===f().lastMode?"pro":"basic"},exports.setGameplayPrefs=function(t){d((n=>{const r=e[null==t?void 0:t.rankMode]?t.rankMode:n.rankMode;return{...n,rankMode:r,ranks:i(r),deckSource:a((null==t?void 0:t.deckSource)??n.deckSource),mixWeight:Number.isFinite(null==t?void 0:t.mixWeight)?Math.min(100,Math.max(0,Math.round(t.mixWeight))):n.mixWeight,haptics:"boolean"==typeof(null==t?void 0:t.haptics)?t.haptics:n.haptics,sfx:"boolean"==typeof(null==t?void 0:t.sfx)?t.sfx:n.sfx,reducedMotion:"boolean"==typeof(null==t?void 0:t.reducedMotion)?t.reducedMotion:n.reducedMotion,rankMigrationNotice:"boolean"==typeof(null==t?void 0:t.rankMigrationNotice)?t.rankMigrationNotice:n.rankMigrationNotice}}))},exports.setLastHintTimestamp=function(t){const e=Number.isFinite(t)?Math.max(0,Math.floor(t)):Date.now();d((t=>({...t,lastHintTs:e})))},exports.setLastMode=function(t){d((e=>({...e,lastMode:"pro"===t?"pro":"basic"})))},exports.writeAvatarMeta=k;
