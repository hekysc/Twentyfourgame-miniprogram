"use strict";const e=require("../common/vendor.js");function t(e){const t=Number(e);return Number.isFinite(t)?Math.max(0,Math.floor(t)):0}function r(e,r){const s=Date.now(),o=r&&"object"==typeof r?r:{},c=function(e,t){return Array.isArray(e)&&e.length?e.map((e=>Number.isFinite(+e)?+e:0)).sort(((e,t)=>e-t)):"string"==typeof t&&t?t.split(",").map((e=>Number.isFinite(+e)?+e:0)).sort(((e,t)=>e-t)):[]}(o.nums,e),n=t(o.attempts),a=t(o.wrong),i=t(o.correct),u=n||a+i,l=t(o.streakCorrect),g=Number.isFinite(+o.lastSeenTs)?+o.lastSeenTs:0,m=Number.isFinite(+o.createdTs)?+o.createdTs:s,f="correct"===o.lastResult||"wrong"===o.lastResult?o.lastResult:null;return{key:"string"==typeof o.key&&o.key?o.key:e,nums:c,attempts:u,wrong:a,correct:i,lastSeenTs:g,lastResult:f,streakCorrect:l,createdTs:m}}function s(t){if(!t)return{active:{},ledger:{}};try{const s=e.index.getStorageSync("mistakes:"+t);if(!s)return{active:{},ledger:{}};const o="string"==typeof s?JSON.parse(s):s;if(!o||"object"!=typeof o)return{active:{},ledger:{}};const c={active:{},ledger:{}},n=o.active&&"object"==typeof o.active?o.active:{},a=o.ledger&&"object"==typeof o.ledger?o.ledger:{};for(const e of Object.keys(n))c.active[e]=r(e,n[e]);for(const e of Object.keys(a))c.ledger[e]=r(e,a[e]);return c}catch(s){return{active:{},ledger:{}}}}exports.getActivePool=function(e){const t=s(e);return Object.values(t.active||{})},exports.getSummary=function(e){var r;const o=s(e),c=o.ledger||{};let n=0;for(const s of Object.keys(c))n+=t(null==(r=c[s])?void 0:r.wrong);return{totalWrongCount:n,totalActiveCount:Object.keys(o.active||{}).length}},exports.loadMistakeBook=s,exports.recordRoundResult=function({userId:o,nums:c,success:n}){if(!o||!Array.isArray(c)||0===c.length)return;const a=c.map((e=>Number.isFinite(+e)?+e:0)).sort(((e,t)=>e-t)),i=function(e=[]){return Array.isArray(e)&&0!==e.length?e.map((e=>Number.isFinite(+e)?+e:0)).sort(((e,t)=>e-t)).join(","):""}(a);if(!i)return;const u=Date.now(),l=s(o),g=l.ledger||{},m=l.active||{},f={...g[i]?r(i,g[i]):r(i,{key:i,nums:a,createdTs:u})};f.nums=a.slice(),f.attempts=t(f.attempts)+1,f.createdTs=Number.isFinite(+f.createdTs)?+f.createdTs:u,f.lastSeenTs=u,f.lastResult=n?"correct":"wrong",n?(f.correct=t(f.correct)+1,f.streakCorrect=t(f.streakCorrect)+1):(f.wrong=t(f.wrong)+1,f.streakCorrect=0),g[i]=f;const d=!!m[i];if(n){if(n&&f.streakCorrect>=5)d&&delete m[i];else if(d){const e=r(i,m[i]);e.nums=a.slice(),e.attempts=f.attempts,e.wrong=f.wrong,e.correct=f.correct,e.lastSeenTs=u,e.lastResult="correct",e.streakCorrect=f.streakCorrect,m[i]=e}}else{const e=r(i,d?m[i]:{key:i,nums:a,createdTs:u});e.nums=a.slice(),e.attempts=f.attempts,e.wrong=f.wrong,e.correct=f.correct,e.lastSeenTs=u,e.lastResult="wrong",e.streakCorrect=0,m[i]=e}l.ledger=g,l.active=m,function(t,r){if(!t)return;const s=r&&"object"==typeof r?r:{active:{},ledger:{}};try{e.index.setStorageSync("mistakes:"+t,JSON.stringify({active:s.active||{},ledger:s.ledger||{}}))}catch(o){}}(o,l)};
