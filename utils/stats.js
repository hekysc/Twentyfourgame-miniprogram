"use strict";function e(e){if(!e||"string"!=typeof e)return null;const n=e.replace(/[×脳]/g,"*").replace(/[÷梅]/g,"/").replace(/\s+/g,"");if(!/^[0-9+\-*/().]+$/.test(n))return null;try{const e=Function('"use strict";return('+n+")")();return"number"==typeof e&&Number.isFinite(e)?e:null}catch(t){return null}}function n(e,n){if(!e.length)return 0;return+e[Math.min(e.length-1,Math.max(0,Math.ceil(n/100*e.length)-1))].toFixed(3)}exports.computeDailySeries=function(e){const n=new Map;for(const t of e||[]){const e=new Date(t.ts||0).toISOString().slice(0,10),s=n.get(e)||{total:0,success:0,successTimes:[]};s.total+=1,t.success&&(s.success+=1,Number.isFinite(t.timeMs)&&s.successTimes.push(t.timeMs)),n.set(e,s)}return Array.from(n.entries()).sort(((e,n)=>e[0]<n[0]?-1:1))},exports.computeOverviewRows=function(e,n,t=0){const s=(e||[]).map((e=>{const s=((n&&n[e.id]||{rounds:[],agg:{}}).rounds||[]).filter((e=>!t||(e.ts||0)>=t)),i=s.length,l=s.filter((e=>e.success)).length,a=i?Math.round(100*l/i):0,u=s.filter((e=>e.success&&Number.isFinite(e.timeMs))).map((e=>e.timeMs)),c=u.length?Math.min(...u):null,m=u.length?Math.round(u.reduce(((e,n)=>e+n),0)/u.length):null,r=i-l;return{id:e.id,name:e.name,total:i,success:l,fail:r,times:i,winRate:a,bestTimeMs:c,avgTimeMs:m}}));return s.sort(((e,n)=>n.winRate-e.winRate||n.times-e.times)),s},exports.computeSpeedBuckets=function(e){const n=[{label:"<5s",min:0,max:5e3,minInclusive:!0,maxInclusive:!1},{label:"5-10s",min:5e3,max:1e4,minInclusive:!0,maxInclusive:!1},{label:"10-20s",min:1e4,max:2e4,minInclusive:!0,maxInclusive:!1},{label:"20-30s",min:2e4,max:3e4,minInclusive:!0,maxInclusive:!1},{label:"30-40s",min:3e4,max:4e4,minInclusive:!0,maxInclusive:!1},{label:"40-50s",min:4e4,max:5e4,minInclusive:!0,maxInclusive:!1},{label:"50-60s",min:5e4,max:6e4,minInclusive:!0,maxInclusive:!1},{label:"60-90s",min:6e4,max:9e4,minInclusive:!0,maxInclusive:!1},{label:"90-120s",min:9e4,max:12e4,minInclusive:!0,maxInclusive:!0},{label:">120s",min:12e4,max:1/0,minInclusive:!1,maxInclusive:!1}],t=n.map((e=>({label:e.label,total:0,success:0,fail:0,totalTimeMs:0}))),s=(e,n)=>{if(!Number.isFinite(e))return!1;const t=!1===n.minInclusive?e>n.min:e>=n.min,s=n.maxInclusive?e<=n.max:e<n.max;return t&&s};for(const i of e||[]){if(!Number.isFinite(null==i?void 0:i.timeMs))continue;const e=Math.max(0,Math.floor(i.timeMs)),l=n.findIndex((n=>s(e,n)));if(l<0)continue;const a=t[l];a.total+=1,i.success?a.success+=1:a.fail+=1,a.totalTimeMs+=e}return t.map((e=>({label:e.label,total:e.total,success:e.success,fail:e.fail,avgTimeMs:e.total?Math.round(e.totalTimeMs/e.total):null})))},exports.summarizeNearMisses=function(t){const s=[];for(const n of t||[])if(n&&!n.success&&"string"==typeof n.expr){const t=e(n.expr);if(null==t)continue;const i=t-24;s.push({abs:Math.abs(i),sign:Math.sign(i)})}const i=s.map((e=>e.abs)).sort(((e,n)=>e-n)),l=i.length;if(!l)return{count:0,median:"-",p90:"-",lt1:0,lt01:0,biasUp:0,biasDown:0};const a=n(i,50),u=n(i,90),c=Math.round(i.filter((e=>e<1)).length/l*100),m=Math.round(i.filter((e=>e<.1)).length/l*100),r=s.filter((e=>e.sign>0)).length,o=s.filter((e=>e.sign<0)).length,f=r+o;return{count:l,median:a,p90:u,lt1:c,lt01:m,biasUp:f?Math.round(100*r/f):0,biasDown:f?Math.round(100*o/f):0}};
