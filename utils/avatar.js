"use strict";const t=require("../common/vendor.js"),e=require("./store.js"),i=require("./prefs.js");function a(){try{if(void 0!==t.index&&"function"==typeof t.index.getFileSystemManager)return t.index.getFileSystemManager()}catch(e){}return null}function n(){try{return"undefined"!=typeof plus&&plus&&plus.io}catch(t){return!1}}function r(t,e=".png"){if(!t)return e;const i=/\.(jpg|jpeg|png|webp)$/i.exec(t);return i?`.${i[1].toLowerCase()}`:e}function o(){try{if(n())return"_doc/profile";if(void 0!==t.index&&t.index.env&&t.index.env.USER_DATA_PATH)return`${t.index.env.USER_DATA_PATH}/profile`;if(void 0!==t.wx$1&&t.wx$1.env&&t.wx$1.env.USER_DATA_PATH)return`${t.wx$1.env.USER_DATA_PATH}/profile`}catch(e){}return""}async function s(t){if(!t)return!1;const e=a();if(e&&"function"==typeof e.access&&"function"==typeof e.mkdir)return await new Promise((i=>{e.access({path:t,success:()=>i(!0),fail:()=>{e.mkdir({dirPath:t,recursive:!0,success:()=>i(!0),fail:()=>i(!1)})}})}));if(e&&"function"==typeof e.mkdirSync)try{return e.mkdirSync(t,!0),!0}catch(i){return!1}return!!n()&&await new Promise((e=>{try{plus.io.resolveLocalFileSystemURL("_doc/",(a=>{const n=t.replace(/^_doc\/?/,"");if(!n)return void e(!0);const r=n.split("/").filter(Boolean);let o=a;!function t(a){if(a>=r.length)return void e(!0);const n=r[a];try{o.getDirectory(n,{create:!0},(e=>{o=e,t(a+1)}),(()=>e(!1)))}catch(i){e(!1)}}(0)}),(()=>e(!1)))}catch(i){e(!1)}}))}async function c(t){if(!t)return!1;const e=a();if(e&&"function"==typeof e.access)return await new Promise((i=>{e.access({path:t,success:()=>i(!0),fail:()=>i(!1)})}));if(e&&"function"==typeof e.accessSync)try{return e.accessSync(t),!0}catch(i){return!1}return e&&"function"==typeof e.stat?await new Promise((i=>{e.stat({path:t,success:()=>i(!0),fail:()=>i(!1)})})):!!n()&&await new Promise((e=>{try{plus.io.resolveLocalFileSystemURL(t,(()=>e(!0)),(()=>e(!1)))}catch(i){e(!1)}}))}async function f(t){if(!t)return!1;const e=a();if(e&&"function"==typeof e.unlink)return await new Promise((i=>{e.unlink({filePath:t,success:()=>i(!0),fail:()=>i(!1)})}));if(e&&"function"==typeof e.unlinkSync)try{return e.unlinkSync(t),!0}catch(i){return!1}return!!n()&&await new Promise((e=>{try{plus.io.resolveLocalFileSystemURL(t,(t=>{t.remove((()=>e(!0)),(()=>e(!1)))}),(()=>e(!1)))}catch(i){e(!1)}}))}async function u(t){if(!t)return null;const e=a();return e&&"function"==typeof e.stat?await new Promise((i=>{e.stat({path:t,success:t=>i({size:t.size||0,lastModified:t.mtime||t.lastModifiedTime||Date.now()}),fail:()=>i(null)})})):e&&"function"==typeof e.getFileInfo?await new Promise((i=>{e.getFileInfo({filePath:t,success:t=>i({size:t.size||0,lastModified:t.lastModifiedTime||Date.now()}),fail:()=>i(null)})})):n()?await new Promise((e=>{try{plus.io.resolveLocalFileSystemURL(t,(t=>{t.getMetadata((t=>{const i=t.size||0,a=t.modificationTime instanceof Date?t.modificationTime.getTime():Date.now();e({size:i,lastModified:a})}),(()=>e(null)))}),(()=>e(null)))}catch(i){e(null)}})):null}async function l(e,i){return e?void 0===t.index||"function"!=typeof t.index.compressImage?{ok:!1,path:e,size:0}:await new Promise((a=>{t.index.compressImage({src:e,quality:i,success:t=>{const i=t&&t.tempFilePath?t.tempFilePath:e;u(i).then((t=>{a({ok:!0,path:i,size:t&&t.size||0})}))},fail:()=>a({ok:!1,path:e,size:0})})})):{ok:!1,path:e,size:0}}function d(t){if(!t)return!1;const e=o();return!!e&&t.startsWith(e)}async function p(t,e,i={}){const c=o();if(!c)return{ok:!1,path:"",lastModified:0};if(!(await s(c)))return{ok:!1,path:"",lastModified:0};const f=`${c}/avatar_${t}${i.ext||r(e)}`,l=await async function(t,e){if(!t||!e)return!1;const i=a();if(i&&"function"==typeof i.copyFile)return await new Promise((a=>{i.copyFile({srcPath:t,destPath:e,success:()=>a(!0),fail:()=>a(!1)})}));if(i&&"function"==typeof i.copyFileSync)try{return i.copyFileSync(t,e),!0}catch(r){}if(i&&"function"==typeof i.readFile&&"function"==typeof i.writeFile){const a=await new Promise((e=>{i.readFile({filePath:t,encoding:"binary",success:t=>e(t.data),fail:()=>e(null)})}));return null!=a&&await new Promise((t=>{i.writeFile({filePath:e,data:a,encoding:"binary",success:()=>t(!0),fail:()=>t(!1)})}))}return!!n()&&await new Promise((i=>{try{plus.io.resolveLocalFileSystemURL(t,(t=>{const a=e.substring(0,e.lastIndexOf("/"))||"_doc",n=e.substring(e.lastIndexOf("/")+1);s(a).then((e=>{if(e)try{plus.io.resolveLocalFileSystemURL(a,(e=>{const a=()=>{t.copyTo(e,n,(()=>i(!0)),(()=>i(!1)))};e.getFile(n,{create:!1},(t=>{t.remove((()=>a()),(()=>a()))}),(()=>a()))}),(()=>i(!1)))}catch(r){i(!1)}else i(!1)}))}),(()=>i(!1)))}catch(r){i(!1)}}))}(e,f);if(!l)return{ok:!1,path:"",lastModified:0};const d=await u(f);return{ok:!0,path:f,lastModified:d&&d.lastModified||Date.now()}}function y(t){const e=[];if(!t)return e;const i=t.id,a=t.avatar;a&&e.push(a);const n=o().replace(/profile$/,"")||"";return n&&(e.push(`${n}Documents/app/avatar_${i}.png`),e.push(`${n}Documents/app/avatar.png`)),e.push(`_doc/avatar_${i}.png`),e.push("_doc/avatar.png"),Array.from(new Set(e.filter(Boolean)))}exports.consumeAvatarRestoreNotice=function(){try{return!!t.index.getStorageSync("tf24_avatar_restore_notice")&&(t.index.removeStorageSync("tf24_avatar_restore_notice"),!0)}catch(e){return!1}},exports.ensureUserAvatars=async function(){const a=e.getUsers(),n=Array.isArray(a.list)?a.list:[];let o=!1,s=0;for(const t of n){if(!t||!t.id)continue;if(!t.avatar){t.avatarUpdatedAt&&(t.avatarUpdatedAt=0,o=!0),i.clearAvatarMeta(t.id);continue}if(await c(t.avatar)){if(!d(t.avatar)){const e=await p(t.id,t.avatar,{ext:r(t.avatar)});if(e.ok&&e.path){const a=t.avatar;t.avatar=e.path,t.avatarUpdatedAt=e.lastModified,o=!0,i.writeAvatarMeta(t.id,{uri:e.path,lastModified:e.lastModified}),a&&a!==e.path&&await f(a)}}continue}let e=!1;for(const a of y(t)){if(!a)continue;if(!(await c(a)))continue;const n=await p(t.id,a,{ext:r(a)});if(n.ok&&n.path){t.avatar=n.path,t.avatarUpdatedAt=n.lastModified,o=!0,i.writeAvatarMeta(t.id,{uri:n.path,lastModified:n.lastModified}),e=!0;break}}e||(t.avatar="",t.avatarUpdatedAt=0,i.clearAvatarMeta(t.id),s+=1,o=!0)}if(o&&e.setUsers(a),s>0)try{t.index.setStorageSync("tf24_avatar_restore_notice",Date.now())}catch(u){}},exports.removeAvatarForUser=async function(t){if(!t)return{ok:!1};const a=(e.getUsers().list||[]).find((e=>e&&e.id===t));if(!a)return{ok:!1};const n=a.avatar||"";return n&&await f(n),e.setUserAvatar(t,"",0),i.clearAvatarMeta(t),{ok:!0}},exports.saveAvatarForUser=async function(a,n,o={}){if(!a||!n)return{ok:!1,error:"invalid",path:"",lastModified:0};const s=(e.getUsers().list||[]).find((t=>t&&t.id===a));if(!s)return{ok:!1,error:"not_found",path:"",lastModified:0};const c=await async function(t,e){if(!t)return{path:"",size:0};let i=Number.isFinite(e)?e:0;if(!i){const e=await u(t);i=e&&e.size||0}if(i>2097152){let e=t;for(const t of[80,60,45]){const a=await l(e,t);if(a.ok&&a.size>0&&(e=a.path,i=a.size,i<=2097152))return{path:e,size:i}}return{path:e,size:i}}return{path:t,size:i}}(n,o.size);if(!c.path)return{ok:!1,error:"invalid",path:"",lastModified:0};let d=c.path,y={ok:!1,path:"",lastModified:0};if(y=(c.size&&c.size,await p(a,d,{ext:r(n)})),!y.ok||!y.path){const e=await async function(e){return e&&void 0!==t.index&&"function"==typeof t.index.saveFile?await new Promise((i=>{t.index.saveFile({tempFilePath:e,success:t=>i(t&&t.savedFilePath?t.savedFilePath:""),fail:()=>i("")})})):""}(d);if(e){const t=await u(e);y={ok:!0,path:e,lastModified:t&&t.lastModified||Date.now()}}}if(!y.ok||!y.path)return{ok:!1,error:"fs_failed",path:"",lastModified:0};const h=s.avatar||"";return h&&h!==y.path&&await f(h),e.setUserAvatar(a,y.path,y.lastModified),i.writeAvatarMeta(a,{uri:y.path,lastModified:y.lastModified}),y};
